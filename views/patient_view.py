import streamlit as st
import pandas as pd
from datetime import datetime
from utils.calculations import (
    calculate_predicted_pefr, 
    get_action_plan_zone, 
    plot_pefr_chart, 
    check_technique_status
)

def render_patient_view(target_hn, patients_db, visits_db):
    if target_hn in patients_db['hn'].values:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ
        pt_data = patients_db[patients_db['hn'] == target_hn].iloc[0]
        pt_visits = visits_db[visits_db['hn'] == target_hn]
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        dob = pd.to_datetime(pt_data['dob'])
        age = (datetime.now() - dob).days // 365
        height = pt_data['height']
        predicted_pefr = calculate_predicted_pefr(age, height, pt_data['prefix'])
        ref_pefr = predicted_pefr if predicted_pefr > 0 else pt_data['best_pefr']

        # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Mask ‡∏ä‡∏∑‡πà‡∏≠
        def mask_text(text):
            if pd.isna(text) or str(text).strip() == "": return "xxx"
            text = str(text)
            if len(text) <= 2: return text[0] + "xxx"
            return text[:2] + "xxx"

        masked_fname = mask_text(pt_data['first_name'])
        masked_lname = mask_text(pt_data['last_name'])
        display_name = f"{pt_data['prefix']}{masked_fname} {masked_lname}"

        # --- Header ---
        st.image("https://img.icons8.com/color/96/asthma.png", width=60)
        st.title(f"‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ {display_name} üëã")
        
        with st.container(border=True):
            c1, c2 = st.columns(2)
            c1.markdown(f"**HN:** `{target_hn}`")
            c2.markdown(f"**‡∏≠‡∏≤‡∏¢‡∏∏:** {age} ‡∏õ‡∏µ")
            st.info(f"üéØ **‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ PEFR ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:** {int(ref_pefr)} L/min")

        # --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Visit ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏¢‡∏≤ & ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥) ---
        if not pt_visits.empty:
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            last_visit_any = pt_visits.sort_values(by="date").iloc[-1]
            
            # 1. ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current Medication)
            curr_controller = str(last_visit_any.get('controller', '-')).strip()
            curr_reliever = str(last_visit_any.get('reliever', '-')).strip()
            
            if curr_controller in ['nan', 'None', '']: curr_controller = "-"
            if curr_reliever in ['nan', 'None', '']: curr_reliever = "-"
            
            if curr_controller != "-" or curr_reliever != "-":
                with st.container(border=True):
                    st.markdown("##### üíä ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô")
                    mc1, mc2 = st.columns(2)
                    with mc1:
                        st.caption("‡∏¢‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (Controller)")
                        if curr_controller != "-":
                            st.success(f"**{curr_controller}**")
                        else:
                            st.markdown("-")
                    with mc2:
                        st.caption("‡∏¢‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Reliever)")
                        if curr_reliever != "-":
                            st.warning(f"**{curr_reliever}**")
                        else:
                            st.markdown("-")
            
            # ‚úÖ 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Advice (‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£)
            # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å key 'note' ‡∏´‡∏£‡∏∑‡∏≠ 'advice'
            curr_advice = str(last_visit_any.get('advice', '-')).strip()
            if curr_advice in ['-', '', 'nan', 'None']:
                curr_advice = str(last_visit_any.get('advice', '-')).strip()
            
            if curr_advice not in ['-', '', 'nan', 'None']:
                with st.container(border=True):
                    st.markdown("##### üí¨ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)")
                    st.info(f"‚ÑπÔ∏è {curr_advice}")

        # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ ---
        if not pt_visits.empty:
            # ‡πÉ‡∏ä‡πâ last_visit_any ‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
            if 'last_visit_any' not in locals():
                last_visit_any = pt_visits.sort_values(by="date").iloc[-1]
                
            next_appt = str(last_visit_any.get('next_appt', '-')).strip()
            
            if next_appt and next_appt not in ['-', '', 'nan', 'None']:
                try:
                    next_appt_dt = pd.to_datetime(next_appt)
                    formatted_date = next_appt_dt.strftime('%d/%m/%Y')
                    days_to_appt = (next_appt_dt - datetime.now()).days + 1
                    
                    if days_to_appt < 0:
                        msg_status = f"(‡πÄ‡∏•‡∏¢‡∏ô‡∏±‡∏î‡∏°‡∏≤ {abs(days_to_appt)} ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)"
                        icon = "‚ö†Ô∏è"
                    elif days_to_appt == 0:
                        msg_status = "(‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!)"
                        icon = "üö®"
                    else:
                        msg_status = f"(‡∏≠‡∏µ‡∏Å {days_to_appt} ‡∏ß‡∏±‡∏ô)"
                        icon = "üìÖ"
                    
                    st.info(f"{icon} **‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:** {formatted_date} {msg_status}")
                except:
                    st.info(f"üìÖ **‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:** {next_appt}")

        # --- ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡πà‡∏ô‡∏¢‡∏≤ ---
        tech_status, _, tech_last_date = check_technique_status(pt_visits)
        
        with st.container(border=True):
            c_icon, c_text = st.columns([1, 4])
            with c_icon:
                if tech_status == "valid": st.markdown("# ‚úÖ")
                elif tech_status == "overdue": st.markdown("# ‚ö†Ô∏è")
                else: st.markdown("# ‚ö™")
            
            with c_text:
                st.markdown("**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡πà‡∏ô‡∏¢‡∏≤**")
                if tech_status == "never":
                    st.warning("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ")
                elif tech_status == "overdue":
                    last_date_str = tech_last_date.strftime('%d/%m/%Y')
                    st.error(f"‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß! (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {last_date_str})")
                else: 
                    if isinstance(tech_last_date, pd.Timestamp):
                        tech_last_date = tech_last_date.to_pydatetime()
                    delta = datetime.now() - tech_last_date
                    days_passed = delta.days
                    if days_passed < 0: days_passed = 0
                    days_remaining = 365 - days_passed
                    
                    last_date_str = tech_last_date.strftime('%d/%m/%Y')
                    st.success(f"‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏™‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {last_date_str})")
                    
                    if days_remaining < 0: days_remaining = 0
                    progress_val = int((days_remaining / 365) * 100)
                    progress_val = max(0, min(100, progress_val))
                    
                    msg = f"‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß {days_passed} ‡∏ß‡∏±‡∏ô (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å {days_remaining} ‡∏ß‡∏±‡∏ô ‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö 1 ‡∏õ‡∏µ)"
                    st.progress(progress_val, text=msg)

        # --- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Logic ‡∏Å‡∏£‡∏≠‡∏á 0 ‡∏≠‡∏≠‡∏Å) ---
        if not pt_visits.empty:
            pt_visits['date'] = pd.to_datetime(pt_visits['date'])
            sorted_visits = pt_visits.sort_values(by="date")
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏≤ Visit ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á (PEFR > 0)
            valid_pefr_visits = sorted_visits[sorted_visits['pefr'] > 0]
            
            if not valid_pefr_visits.empty:
                last_valid_visit = valid_pefr_visits.iloc[-1]
                current_pefr = last_valid_visit['pefr']
                visit_date_str = last_valid_visit['date'].strftime('%d/%m/%Y')
                
                zone_name, zone_color, advice = get_action_plan_zone(current_pefr, ref_pefr)
                
                st.divider()
                st.subheader(f"‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")
                st.caption(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠: {visit_date_str}")
                
                last_actual_date = sorted_visits.iloc[-1]['date'].strftime('%d/%m/%Y')
                if visit_date_str != last_actual_date:
                    st.caption(f"‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ {last_actual_date} ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πà‡∏≤ Peak Flow ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∂‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ó‡∏ô")

                st.metric("‡∏Ñ‡πà‡∏≤ PEFR ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", f"{current_pefr} L/min")
                
                st.markdown(f"""
                <div style="padding: 20px; border-radius: 10px; background-color: {zone_color}15; border: 2px solid {zone_color}; margin-bottom: 15px;">
                    <h3 style="color: {zone_color}; margin:0 0 10px 0;">{zone_name}</h3>
                    <div style="font-size: 16px; line-height: 1.6; color: #333;">
                        {advice}
                    </div>
                </div>
                """, unsafe_allow_html=True)

                # ‡∏õ‡∏∏‡πà‡∏° Action ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                if "Green" in zone_name:
                    with st.expander("üì¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏û‡πà‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (MDI) ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ñ‡∏•‡∏¥‡∏Å)"):
                        st.markdown("""
                        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡πà‡∏ô‡∏¢‡∏≤:**
                        1. üü¢ **‡∏ñ‡∏≠‡∏î‡∏ù‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö** ‡∏´‡∏•‡∏≠‡∏î‡∏û‡πà‡∏ô‡∏¢‡∏≤‡∏≠‡∏≠‡∏Å ‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏π‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°
                        2. üîÑ **‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏î** ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏á‡πÜ 4-5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        3. üòÆ‚Äçüí® **‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å** ‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏î (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏û‡πà‡∏ô‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
                        4. üëÑ **‡∏≠‡∏°‡∏õ‡∏≤‡∏Å‡∏´‡∏•‡∏≠‡∏î** ‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏¥‡πâ‡∏ô‡∏ö‡∏±‡∏á‡∏£‡∏π‡∏û‡πà‡∏ô‡∏¢‡∏≤)
                        5. üå¨Ô∏è **‡∏Å‡∏î‡∏´‡∏•‡∏≠‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏π‡∏î‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤** ‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å **‡∏ä‡πâ‡∏≤‡πÜ ‡πÅ‡∏•‡∏∞‡∏•‡∏∂‡∏Å‡πÜ** (‡∏Å‡∏î 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏î 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
                        6. ‚úã **‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à** ‡πÑ‡∏ß‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏≠‡∏î‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
                        7. üòå **‡∏ú‡πà‡∏≠‡∏ô‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à** ‡∏≠‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏°‡∏π‡∏Å‡∏ä‡πâ‡∏≤‡πÜ
                        
                        ---
                        **‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:**
                        * ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì **1-2 ‡∏ô‡∏≤‡∏ó‡∏µ** ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠ 2
                        * ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏û‡πà‡∏ô‡∏¢‡∏≤ (Spacer) ‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
                        * ‡∏Ñ‡∏ß‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏û‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡πÄ‡∏ï‡∏µ‡∏¢‡∏£‡∏≠‡∏¢‡∏î‡πå (‡πÄ‡∏ä‡πà‡∏ô Seretide, Budesonide)
                        """)
                        st.info("üí° ‡∏Ñ‡∏ß‡∏£‡∏û‡∏Å‡∏¢‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏™‡∏°‡∏≠")

                elif "Yellow" in zone_name:
                    with st.expander("üì¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏û‡πà‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (MDI) ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ñ‡∏•‡∏¥‡∏Å)"):
                        st.markdown("""
                        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡πà‡∏ô‡∏¢‡∏≤:**
                        1. üü¢ **‡∏ñ‡∏≠‡∏î‡∏ù‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö** ‡∏´‡∏•‡∏≠‡∏î‡∏û‡πà‡∏ô‡∏¢‡∏≤‡∏≠‡∏≠‡∏Å ‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏π‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°
                        2. üîÑ **‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏î** ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏á‡πÜ 4-5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        3. üòÆ‚Äçüí® **‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å** ‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏î (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏û‡πà‡∏ô‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
                        4. üëÑ **‡∏≠‡∏°‡∏õ‡∏≤‡∏Å‡∏´‡∏•‡∏≠‡∏î** ‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏¥‡πâ‡∏ô‡∏ö‡∏±‡∏á‡∏£‡∏π‡∏û‡πà‡∏ô‡∏¢‡∏≤)
                        5. üå¨Ô∏è **‡∏Å‡∏î‡∏´‡∏•‡∏≠‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏π‡∏î‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤** ‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å **‡∏ä‡πâ‡∏≤‡πÜ ‡πÅ‡∏•‡∏∞‡∏•‡∏∂‡∏Å‡πÜ** (‡∏Å‡∏î 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏î 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
                        6. ‚úã **‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à** ‡πÑ‡∏ß‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏≠‡∏î‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
                        7. üòå **‡∏ú‡πà‡∏≠‡∏ô‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à** ‡∏≠‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏°‡∏π‡∏Å‡∏ä‡πâ‡∏≤‡πÜ
                        
                        ---
                        **‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:**
                        * ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì **1-2 ‡∏ô‡∏≤‡∏ó‡∏µ** ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠ 2
                        * ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏û‡πà‡∏ô‡∏¢‡∏≤ (Spacer) ‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
                        * ‡∏Ñ‡∏ß‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏û‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡πÄ‡∏ï‡∏µ‡∏¢‡∏£‡∏≠‡∏¢‡∏î‡πå (‡πÄ‡∏ä‡πà‡∏ô Seretide, Budesonide)
                        """)
                        st.info("üí° ‡∏Ñ‡∏ß‡∏£‡∏û‡∏Å‡∏¢‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏™‡∏°‡∏≠")

                elif "Red" in zone_name:
                    with st.expander("üì¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏û‡πà‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (MDI) ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ñ‡∏•‡∏¥‡∏Å)"):
                        st.markdown("""
                        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡πà‡∏ô‡∏¢‡∏≤:**
                        1. üü¢ **‡∏ñ‡∏≠‡∏î‡∏ù‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö** ‡∏´‡∏•‡∏≠‡∏î‡∏û‡πà‡∏ô‡∏¢‡∏≤‡∏≠‡∏≠‡∏Å ‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏π‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°
                        2. üîÑ **‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏î** ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏á‡πÜ 4-5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        3. üòÆ‚Äçüí® **‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å** ‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏î (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏û‡πà‡∏ô‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
                        4. üëÑ **‡∏≠‡∏°‡∏õ‡∏≤‡∏Å‡∏´‡∏•‡∏≠‡∏î** ‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏¥‡πâ‡∏ô‡∏ö‡∏±‡∏á‡∏£‡∏π‡∏û‡πà‡∏ô‡∏¢‡∏≤)
                        5. üå¨Ô∏è **‡∏Å‡∏î‡∏´‡∏•‡∏≠‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏π‡∏î‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤** ‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å **‡∏ä‡πâ‡∏≤‡πÜ ‡πÅ‡∏•‡∏∞‡∏•‡∏∂‡∏Å‡πÜ** (‡∏Å‡∏î 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏î 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
                        6. ‚úã **‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à** ‡πÑ‡∏ß‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏≠‡∏î‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
                        7. üòå **‡∏ú‡πà‡∏≠‡∏ô‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à** ‡∏≠‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏°‡∏π‡∏Å‡∏ä‡πâ‡∏≤‡πÜ
                        
                        ---
                        **‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:**
                        * ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì **1-2 ‡∏ô‡∏≤‡∏ó‡∏µ** ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠ 2
                        * ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏û‡πà‡∏ô‡∏¢‡∏≤ (Spacer) ‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
                        * ‡∏Ñ‡∏ß‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏û‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡πÄ‡∏ï‡∏µ‡∏¢‡∏£‡∏≠‡∏¢‡∏î‡πå (‡πÄ‡∏ä‡πà‡∏ô Seretide, Budesonide)
                        """)
                        st.info("üí° ‡∏Ñ‡∏ß‡∏£‡∏û‡∏Å‡∏¢‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏™‡∏°‡∏≠")
                    
                    col_btn1, col_btn2 = st.columns(2)
                    with col_btn1:
                        st.link_button("üìû ‡πÇ‡∏ó‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 1669", "tel:1669", type="primary", use_container_width=True)
                    with col_btn2:
                        st.error("üö® ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏Å‡∏§‡∏ï! ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏≠‡∏ä‡πâ‡∏≤")

                # ‡∏Å‡∏£‡∏≤‡∏ü (‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏õ‡∏û‡∏•‡πá‡∏≠‡∏ï)
                st.subheader("üìà ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πà‡∏≤‡∏õ‡∏≠‡∏î (Peak Flow)")
                chart = plot_pefr_chart(valid_pefr_visits, ref_pefr)
                st.altair_chart(chart, use_container_width=True)

            else:
                st.divider()
                st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πà‡∏≤ Peak Flow (‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏¢‡∏≤)")
                st.caption("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡πà‡∏≤ Peak Flow ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£")
            
        else:
            st.warning("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à")

    else:
        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ")


